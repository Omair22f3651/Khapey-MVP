2025-08-12 05:51:59,930 - DEBUG - Review data prepared: {
  "restaurantName": "HomeRina Nihari",
  "branchName": "DHA Branch",
  "serviceType": "dineIn",
  "totalBill": 1500.0,
  "rateUserExperience": {
    "foodTaste": 4,
    "ambience": 4,
    "staff": 3,
    "willRecommend": 4
  },
  "averageRating": 3.75,
  "userThoughts": "Nihari best in town",
  "hashtags": [
    "nihari",
    "nihari"
  ]
}
2025-08-12 05:51:59,931 - DEBUG - Starting analyze_review for 1 media files.
2025-08-12 05:51:59,931 - DEBUG - Processing media 1/1...
2025-08-12 05:51:59,931 - DEBUG - Media 1 detected as video, filename: chicken nihari review \U0001f60d day-117 badiya tha taste \U0001f600 #shorts #streetfood.mp4, content_type: video/mp4
2025-08-12 05:51:59,931 - DEBUG - Assigned image_id: e86f7942-8884-4b37-a15d-ae2fb86d99a4
2025-08-12 05:51:59,931 - DEBUG - Opening media for image_id: e86f7942-8884-4b37-a15d-ae2fb86d99a4
2025-08-12 05:51:59,932 - DEBUG - Video data prepared for image_id: e86f7942-8884-4b37-a15d-ae2fb86d99a4, size: 1.08MB
2025-08-12 05:51:59,932 - DEBUG - Prompt for image_id e86f7942-8884-4b37-a15d-ae2fb86d99a4:
Khapey-Mod v1.3 — Vision-LLM for a Pakistani food platform.

You will be provided either an image or a video related to food or restaurant contexts.

Return a JSON array with one object per media file (image or video), using this schema:
{
  "image_id": string,
  "scene": "dish_closeup" | "beverage" | "menu" | "ambiance",
  "visual": {
    "description": string,
    "confidence": float,
    "quality": float,
    "appeal_score": float
  },
  "context": {
    "ambiance": "indoor" | "outdoor" | "mixed" | "none" | "unknown",
    "lighting": "daylight" | "warm" | "lowlight" | "mixed" | "unknown",
    "meal_timing": "breakfast" | "lunch" | "dinner" | "tea_time" | "any" | "unknown"
  },
  "items": [ { "name": string, "confidence": float } ],
  "flag_type": "none" | "low_appeal" | "poor_lighting" | "half_eaten" | "receipt" | "face" | "duplicate" | "inappropriate",
  "penalty_score": int,
  "keywords": [string],
  "ambience_features": [string],
  "thumbnail_rank": float
}

If the media shows no food/restaurant context, return [{"not_food_related": true}].

Special Instructions:
- Apply the same analysis criteria for both still images and videos.
- For videos, consider the overall scene across multiple frames, not just one frame.
- Use Pakistani cuisine terms (e.g., 'nihari', 'biryani').
- Exclude 'embedding' field from JSON output.
- Output only valid JSON with no extra text or explanation.
Generate analysis for image_id: e86f7942-8884-4b37-a15d-ae2fb86d99a4. Ensure Pakistani cuisine terms are used (e.g., 'nihari', 'biryani'). Use the following user-provided context to enhance analysis:
User description: Nihari best in town
Hashtags: #nihari #nihari
Return response in JSON format.
2025-08-12 05:51:59,933 - DEBUG - Sending media to Gemini model for image_id: e86f7942-8884-4b37-a15d-ae2fb86d99a4, mime_type: video/mp4
2025-08-12 05:52:02,911 - DEBUG - Received response for image_id: e86f7942-8884-4b37-a15d-ae2fb86d99a4
2025-08-12 05:52:02,912 - DEBUG - Raw Gemini response for image_id e86f7942-8884-4b37-a15d-ae2fb86d99a4:
The video shows a close-up of a person eating a meal. They are seen tearing off pieces of naan bread and dipping them into a creamy, greenish curry. The curry appears to have chunks of meat in it, possibly chicken, and is garnished with chopped green herbs. Another bowl of curry, a darker reddish-brown, is also visible in the foreground. The meal is served on a wooden table, and the text "THISISSAHARANPUR" is overlaid on the video.
Raw response for image_id e86f7942-8884-4b37-a15d-ae2fb86d99a4:
The video shows a close-up of a person eating a meal. They are seen tearing off pieces of naan bread and dipping them into a creamy, greenish curry. The curry appears to have chunks of meat in it, possibly chicken, and is garnished with chopped green herbs. Another bowl of curry, a darker reddish-brown, is also visible in the foreground. The meal is served on a wooden table, and the text "THISISSAHARANPUR" is overlaid on the video.
==================================================
2025-08-12 05:52:02,913 - DEBUG - Cleaned response for image_id e86f7942-8884-4b37-a15d-ae2fb86d99a4:
The video shows a close-up of a person eating a meal. They are seen tearing off pieces of naan bread and dipping them into a creamy, greenish curry. The curry appears to have chunks of meat in it, possibly chicken, and is garnished with chopped green herbs. Another bowl of curry, a darker reddish-brown, is also visible in the foreground. The meal is served on a wooden table, and the text "THISISSAHARANPUR" is overlaid on the video.
Cleaned response for image_id e86f7942-8884-4b37-a15d-ae2fb86d99a4:
The video shows a close-up of a person eating a meal. They are seen tearing off pieces of naan bread and dipping them into a creamy, greenish curry. The curry appears to have chunks of meat in it, possibly chicken, and is garnished with chopped green herbs. Another bowl of curry, a darker reddish-brown, is also visible in the foreground. The meal is served on a wooden table, and the text "THISISSAHARANPUR" is overlaid on the video.
==================================================
2025-08-12 05:52:02,913 - WARNING - JSON parsing error for image_id e86f7942-8884-4b37-a15d-ae2fb86d99a4: Expecting value: line 1 column 1 (char 0). Falling back to text-based analysis.
JSON error for image_id e86f7942-8884-4b37-a15d-ae2fb86d99a4: Expecting value: line 1 column 1 (char 0)
Response: The video shows a close-up of a person eating a meal. They are seen tearing off pieces of naan bread and dipping them into a creamy, greenish curry. The curry appears to have chunks of meat in it, possibly chicken, and is garnished with chopped green herbs. Another bowl of curry, a darker reddish-brown, is also visible in the foreground. The meal is served on a wooden table, and the text "THISISSAHARANPUR" is overlaid on the video.
==================================================
2025-08-12 05:52:02,941 - DEBUG - Fallback JSON created for image_id e86f7942-8884-4b37-a15d-ae2fb86d99a4: [
  {
    "image_id": "e86f7942-8884-4b37-a15d-ae2fb86d99a4",
    "visual": {
      "quality": 5.0,
      "description": "Food scene",
      "confidence": 0.8,
      "appeal_score": 0.7
    },
    "scene": "dish_closeup",
    "context": {
      "ambiance": "unknown",
      "lighting": "unknown",
      "meal_timing": "unknown"
    },
    "keywords": [
      "video",
      "close",
      "person",
      "meal",
      "pieces",
      "naan",
      "bread"
    ],
    "items": [
      {
        "name": "curry",
        "confidence": 0.8
      },
      {
        "name": "nihari",
        "confidence": 0.8
      }
    ],
    "flag_type": "none",
    "penalty_score": 0,
    "thumbnail_rank": 0.5,
    "is_video": true
  }
]
2025-08-12 05:52:02,946 - DEBUG - Created temporary video file: C:\Users\mamuj\AppData\Local\Temp\tmpxqrfyltk.mp4
2025-08-12 05:52:02,971 - DEBUG - Video metadata - frames: 134, fps: 30.00, duration: 4.47s
2025-08-12 05:52:02,990 - DEBUG - Extracted frame 1/2 at position 0
2025-08-12 05:52:02,994 - DEBUG - Starting new HTTPS connection (1): api-atlas.nomic.ai:443
2025-08-12 05:52:04,008 - DEBUG - https://api-atlas.nomic.ai:443 "GET /v1/user HTTP/1.1" 307 0
2025-08-12 05:52:04,326 - DEBUG - https://api-atlas.nomic.ai:443 "GET /v1/user/ HTTP/1.1" 200 None
2025-08-12 05:52:04,345 - DEBUG - Starting new HTTPS connection (1): api-atlas.nomic.ai:443
2025-08-12 05:52:05,613 - DEBUG - https://api-atlas.nomic.ai:443 "POST /v1/embedding/image HTTP/1.1" 200 None
2025-08-12 05:52:05,614 - DEBUG - Generated embedding for frame 1, length: 768
2025-08-12 05:52:05,624 - DEBUG - Extracted frame 2/2 at position 67
2025-08-12 05:52:05,628 - DEBUG - Starting new HTTPS connection (1): api-atlas.nomic.ai:443
2025-08-12 05:52:06,166 - DEBUG - https://api-atlas.nomic.ai:443 "POST /v1/embedding/image HTTP/1.1" 200 None
2025-08-12 05:52:06,168 - DEBUG - Generated embedding for frame 2, length: 768
2025-08-12 05:52:06,178 - DEBUG - Deleted temporary video file: C:\Users\mamuj\AppData\Local\Temp\tmpxqrfyltk.mp4
2025-08-12 05:52:06,178 - INFO - Generated mean video embedding from 2 frames, length: 768
2025-08-12 05:52:06,179 - DEBUG - Embedding assigned for image_id e86f7942-8884-4b37-a15d-ae2fb86d99a4, length: 768, is_video: True
2025-08-12 05:52:06,181 - DEBUG - Created temporary video file: C:\Users\mamuj\AppData\Local\Temp\tmprzlmt_u_.mp4
2025-08-12 05:52:06,196 - DEBUG - Video metadata - frames: 134, fps: 30.00, duration: 4.47s
2025-08-12 05:52:06,210 - DEBUG - Extracted frame 1/2 at position 0
2025-08-12 05:52:06,214 - DEBUG - Starting new HTTPS connection (1): api-atlas.nomic.ai:443
2025-08-12 05:52:06,801 - DEBUG - https://api-atlas.nomic.ai:443 "POST /v1/embedding/image HTTP/1.1" 200 None
2025-08-12 05:52:06,803 - DEBUG - Generated embedding for frame 1, length: 768
2025-08-12 05:52:06,814 - DEBUG - Extracted frame 2/2 at position 67
2025-08-12 05:52:06,817 - DEBUG - Starting new HTTPS connection (1): api-atlas.nomic.ai:443
2025-08-12 05:52:07,437 - DEBUG - https://api-atlas.nomic.ai:443 "POST /v1/embedding/image HTTP/1.1" 200 None
2025-08-12 05:52:07,439 - DEBUG - Generated embedding for frame 2, length: 768
2025-08-12 05:52:07,447 - DEBUG - Deleted temporary video file: C:\Users\mamuj\AppData\Local\Temp\tmprzlmt_u_.mp4
2025-08-12 05:52:07,447 - INFO - Generated mean video embedding from 2 frames, length: 768
2025-08-12 05:52:07,449 - DEBUG - Created temporary video file for keyframe: C:\Users\mamuj\AppData\Local\Temp\tmp3fjdgfwv.mp4
2025-08-12 05:52:07,467 - DEBUG - Video has 134 frames
2025-08-12 05:52:07,490 - DEBUG - Deleted temporary video file: C:\Users\mamuj\AppData\Local\Temp\tmp3fjdgfwv.mp4
2025-08-12 05:52:07,492 - DEBUG - Generated JPEG keyframe for video.
2025-08-12 05:52:07,492 - DEBUG - Media 1 processed successfully, quality: 5.0
2025-08-12 05:52:07,492 - INFO - Aggregated quality_score: 5.00
2025-08-12 05:52:07,494 - DEBUG - close.started
2025-08-12 05:52:07,494 - DEBUG - close.complete
2025-08-12 05:52:07,494 - DEBUG - connect_tcp.started host='35f22026-33fa-458c-b77f-9ac268313032.eu-central-1-0.aws.cloud.qdrant.io' port=6333 local_address=None timeout=5.0 socket_options=None
2025-08-12 05:52:07,677 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001FBC00A70D0>
2025-08-12 05:52:07,677 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001FBBFCEF920> server_hostname='35f22026-33fa-458c-b77f-9ac268313032.eu-central-1-0.aws.cloud.qdrant.io' timeout=5.0
2025-08-12 05:52:07,891 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001FBC1D14650>
2025-08-12 05:52:07,892 - DEBUG - send_request_headers.started request=<Request [b'PUT']>
2025-08-12 05:52:07,892 - DEBUG - send_request_headers.complete
2025-08-12 05:52:07,892 - DEBUG - send_request_body.started request=<Request [b'PUT']>
2025-08-12 05:52:07,892 - DEBUG - send_request_body.complete
2025-08-12 05:52:07,892 - DEBUG - receive_response_headers.started request=<Request [b'PUT']>
2025-08-12 05:52:08,391 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Content-Encoding', b'gzip'), (b'Content-Type', b'application/json'), (b'Date', b'Tue, 12 Aug 2025 00:52:13 GMT'), (b'Vary', b'accept-encoding, Origin, Access-Control-Request-Method, Access-Control-Request-Headers'), (b'Transfer-Encoding', b'chunked')])
2025-08-12 05:52:08,392 - INFO - HTTP Request: PUT https://35f22026-33fa-458c-b77f-9ac268313032.eu-central-1-0.aws.cloud.qdrant.io:6333/collections/khapey_reviews/points?wait=true "HTTP/1.1 200 OK"
2025-08-12 05:52:08,392 - DEBUG - receive_response_body.started request=<Request [b'PUT']>
2025-08-12 05:52:08,392 - DEBUG - receive_response_body.complete
2025-08-12 05:52:08,393 - DEBUG - response_closed.started
2025-08-12 05:52:08,393 - DEBUG - response_closed.complete
2025-08-12 05:52:08,394 - INFO - Stored review in Qdrant with point_id: 3797169b-5b08-4364-a00d-c70743794e36, is_video: True
2025-08-12 05:52:08,394 - DEBUG - Calculating reach...
2025-08-12 05:52:08,395 - INFO - Reach calculation - quality_score: 5.00, reputation_score: 1.73, penalty_multiplier: 1.00, initial_reach: 3.00, reach_level: Search-only (no feed distribution)
2025-08-12 05:52:08,395 - INFO - Reach calculation completed.
2025-08-12 05:52:08,395 - INFO - Review processing completed successfully.
2025-08-12 05:52:08,397 - INFO - 127.0.0.1 - - [12/Aug/2025 05:52:08] "POST /process_review HTTP/1.1" 200 -
